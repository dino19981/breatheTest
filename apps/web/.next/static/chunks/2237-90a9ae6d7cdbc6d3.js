"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2237],{877:(e,t,r)=>{r.d(t,{Ay:()=>o,HU:()=>l,n3:()=>a,wV:()=>u});let n=(0,r(2444).Z0)({name:"sessions",initialState:{sessions:[],isBreathSessionActive:!1},reducers:{addSession:(e,t)=>{e.sessions.push(t.payload)},resetSessions:e=>{e.sessions=[]},setSessionActive(e,t){e.isBreathSessionActive=t.payload}}}),{addSession:u,resetSessions:a,setSessionActive:l}=n.actions,o=n.reducer},2155:(e,t,r)=>{r.d(t,{GE:()=>n,JR:()=>o,K2:()=>a,ef:()=>l,u0:()=>u});let n=48e3,u=5,a=.2,l="https://websocket-confused-pasternak-ipv3wws5sq-ma.a.run.app/ws",o="https://server-ipv3wws5sq-ma.a.run.app/api"},2237:(e,t,r)=>{r.d(t,{SessionProvider:()=>b,w:()=>k});var n=r(7426),u=r(682),a=r(2784),l=r(2155),o=r(4400),i=r(4225),s=r(6426),c=r(7456);let d=()=>{let e=(0,u.useRef)(null),[t,r]=(0,u.useState)(null),n=(0,u.useCallback)(()=>{e.current&&clearInterval(e.current),e.current=null,r(null)},[]),a=(0,u.useCallback)((t,n)=>{e.current&&clearInterval(e.current),r(t);let u=t;e.current=setInterval(()=>{0==(u-=1)?(clearInterval(e.current),e.current=null,r(null),null==n||n()):r(u)},1e3)},[]);return(0,u.useEffect)(()=>()=>n(),[n]),{countdown:t,start:a,reset:n}},h=e=>{let t=(0,u.useRef)(null),[r,n]=(0,u.useState)(!0),[a,l]=(0,u.useState)(!1);return(0,u.useEffect)(()=>{t.current&&(e?t.current.play().then(()=>l(!0)).catch(console.error):(t.current.pause(),t.current.currentTime=0,l(!1)))},[e]),(0,u.useEffect)(()=>{t.current&&(t.current.muted=r)},[r]),{audioRef:t,musicMuted:r,setMusicMuted:n,musicPlaying:a}};var p=r(5561),f=r(3136),v=r(877);let m=e=>1===e?"inhale":2===e?"exhale":null!==e?"hold":null,S=e=>{let{socketEnabled:t,getSessionEvents:r,phaseAt:n,protocolName:a,sessionStart:l}=e,o=(0,p.wA)();return(0,u.useCallback)(()=>{let e=[];if(t){let t=r().filter(e=>"prediction"===e.type),u=c.WH[a];e=t.map(e=>{let t=e.timestamp-l,r=n(t),a=(r in u?u[r]:0)*c.kZ,o=[r,n(t-a),n(t+a)].map(e=>"holdWithout"===e?"hold":e),i=m(e.value),s="holdWithout"===i?"hold":i,d=o.includes(null!=s?s:"hold");return{...e,actualPhase:e.predictionLabel,expectedPhase:r,isCorrect:d}})}o((0,v.wV)({id:(0,f.A)(),createdAt:Date.now(),events:e,isCorrect:!e.length||e.every(e=>e.isCorrect)}))},[t,r,n,a,l,o])};var w=r(4578);let g=(0,u.createContext)(void 0);function b(e){let{children:t}=e,r=(0,a.j)(),{socketEnabled:p,echoCancellation:f,noiseSuppression:m,autoGainControl:b,recordEnabled:k}=(0,a.G)(e=>e.audioSettings),[C,y]=(0,u.useState)(!1),[R,E]=(0,u.useState)(!1),[W,A]=(0,u.useState)(!1),[D,T]=(0,u.useState)(!1),[x,P]=(0,u.useState)(0),[_,M]=(0,u.useState)(null),[N,G]=(0,u.useState)("Focus"),I=c.WH[N],L=Object.fromEntries(Object.entries(I).map(e=>{let[t,r]=e;return[t,Math.round(r/1e3)]})),{countdown:O,start:q}=d(),{audioRef:U,musicMuted:j,setMusicMuted:B}=h(C),{request:F}=function(){let[e,t]=(0,u.useState)("unknown"),r=(0,u.useCallback)(async()=>{if("unknown"!==e)return"granted"===e;console.log("requestrequestrequest");try{return await navigator.mediaDevices.getUserMedia({audio:!0}),t("granted"),!0}catch(e){return console.error("[useMicPermission] ❌ Permission denied:",e),t("denied"),!1}},[e]);return{status:e,request:r}}(),{phase:H,phaseAt:J}=(0,c.hf)(C,D,N),{startAudioStream:Z,audioStreamRef:V}=function(e){let{echoCancellation:t,noiseSuppression:r,autoGainControl:n}=e,a=(0,u.useRef)(null);return{startAudioStream:(0,u.useCallback)(async()=>{var e,u,o;if(a.current)return;console.log(navigator.mediaDevices,"navigator.mediaDevices",location.protocol),a.current=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,echoCancellation:t&&s.bW,noiseSuppression:r&&s.MG,autoGainControl:n&&s.Q9}});let i=null==(u=a.current)||null==(e=u.getAudioTracks())?void 0:e[0],c=null==i||null==(o=i.getSettings())?void 0:o.sampleRate;return null!=c?c:l.GE},[t,r,n,a.current]),audioStreamRef:a}}({echoCancellation:f,noiseSuppression:m,autoGainControl:b,voiceIsolation:!1}),{socketStatus:Q,sendAudioData:K,getSessionEvents:Y,connectSocket:z,disconnectSocket:X,prediction:$,predictionIdx:ee,predictionLabel:et}=function(e){var t;let{currentPhase:r}=e,[n,a]=(0,u.useState)("Idle"),[s,c]=(0,u.useState)("none"),[d,h]=(0,u.useState)(null),[p,f]=(0,u.useState)(null),[v,m]=(0,u.useState)(null),S=(0,u.useRef)(null),w=(0,u.useRef)([]),g=(0,u.useRef)([]),b=(0,u.useCallback)(e=>{var t;if("number"!=typeof e.prediction)return;k({probabilities:null!=(t=e.probabilities)?t:[],prediction:e.prediction,predictionLabel:e.prediction_label});let n={type:"prediction",value:e.prediction,predictionLabel:e.prediction_label,confidence:e.confidence,probabilities:e.probabilities,inferenceTime:e.inference_time,timestamp:Date.now(),realPhase:r,isSuccessfulPrediction:d===o.a_[r]};w.current.push(n),g.current.push(n)},[r]),k=(0,u.useCallback)(e=>{let{probabilities:t,prediction:n,predictionLabel:u}=e;function a(e,r){var n;let u=null!=(n=t[e])?n:0;return g.current.at(-1),!!new i.g(u.toString()).gt(l.K2)&&(h(e),m(r),f(e=>(e||0)+1),!0)}!("inhale"===r&&a(1,"inhale")||"exhale"===r&&a(2,"exhale"))&&(("hold"===r||"holdWithout"===r)&&a(0,"hold")||(console.log("predictionLabel",u),h(n),m(u),f(e=>(e||0)+1)))},[r]),C=(0,u.useCallback)(e=>{let{skipRecording:t=!1,inputDeviceSampleRate:r}=e;if(S.current&&(S.current.readyState===WebSocket.OPEN||S.current.readyState===WebSocket.CONNECTING))return;let n=new WebSocket(function(e){let{record:t,resampleFrom:r,url:n}=e;return"".concat(n,"?record=").concat(t,"&resample_from=").concat(r)}({record:!t,resampleFrom:r,url:l.ef}));S.current=n,a("Connecting"),n.onopen=()=>{a("Connected"),w.current.push({type:"connected",timestamp:Date.now()})},n.onerror=e=>{console.error("[useBreathSocket] WebSocket error:",e),a("Error"),c("error"),w.current.push({type:"error",error:Error("WebSocket error:"+e),timestamp:Date.now()})},n.onclose=()=>{a("Closed"),c("closed"),w.current.push({type:"closed",timestamp:Date.now()})}},[]);(0,u.useEffect)(()=>{var e;(null==(e=S.current)?void 0:e.readyState)===WebSocket.OPEN&&(S.current.onmessage=e=>{try{let t=JSON.parse(e.data);b(t)}catch(e){console.warn("[useBreathSocket] JSON parse error:",e)}})},[b,null==(t=S.current)?void 0:t.readyState]);let y=(0,u.useCallback)(()=>{S.current&&(S.current.close(),S.current=null,a("Closed"),h(null),f(null),m(null))},[]);return{socketStatus:n,socketFailure:s,prediction:d,predictionIdx:p,predictionLabel:v,connectSocket:C,disconnectSocket:y,sendAudioData:(0,u.useCallback)(e=>{var t;(null==(t=S.current)?void 0:t.readyState)===WebSocket.OPEN&&S.current.send(e)},[]),getSessionEvents:(0,u.useCallback)(()=>w.current,[])}}({currentPhase:H}),er=(0,u.useRef)(0),{startRecording:en,stopRecording:eu}=function(e){let{paused:t,onChunk:r,onPermissionResult:n,audioStreamRef:a}=e,l=(0,u.useRef)([]),o=(0,u.useRef)(null),i=(0,u.useRef)(!1),c=(0,u.useRef)(!1),d=(0,u.useRef)(!1);(0,u.useEffect)(()=>{d.current=t},[t]);let{mimeType:h,type:p}=(0,u.useMemo)(()=>(function(){let e={mimeType:"audio/webm",type:"webm"};return(0,s.nr)()&&(e.mimeType="audio/mp4",e.type="mp4"),MediaRecorder.isTypeSupported("audio/webm")&&(e.mimeType="audio/webm",e.type="webm"),console.error("Failed to get supported MIME type for MediaRecorder"),e})(),[]),f=()=>{if(console.log(l.current.length,"audioChunksRef.current"),0===l.current.length)return;let e=new Blob(l.current,{type:h});new Audio(URL.createObjectURL(e)).play()},v=(0,u.useCallback)(async()=>{if(i.current){i.current=!1;try{if(o.current.stop(),setTimeout(f,201),a.current){var e;null==(e=a.current)||e.getTracks().forEach(e=>e.stop()),a.current=null}}catch(e){console.warn("[AudioRecorder] Error during cleanup:",e)}}},[a,i]);return{startRecording:(0,u.useCallback)(async()=>{try{if(!a.current)return;let e=new MediaRecorder(a.current,{mimeType:h});e.ondataavailable=async e=>{if(e.data.size>0){l.current.push(e.data);let t=await e.data.arrayBuffer();r(t)}},o.current=e,e.start(200),i.current=!0,c.current||(c.current=!0,null==n||n(!0))}catch(e){console.error("[AudioRecorder] ❌ Failed to start:",e),c.current||(c.current=!0,null==n||n(!1))}},[a,i,c,n,r]),stopRecording:v}}({paused:D,onChunk:K,audioStreamRef:V}),ea=async()=>{if(C||null!==O)return;let e=await Z();z({skipRecording:!k,inputDeviceSampleRate:null!=e?e:l.GE}),q(3,()=>el(null!=e?e:l.GE))},el=e=>{if(!C){if(M(Date.now()),en(),r((0,v.HU)(!0)),A(!0),p&&"Connecting"===Q){er.current=Date.now(),y(!0);return}er.current=Date.now(),y(!0)}},eo=S({socketEnabled:p,getSessionEvents:Y,phaseAt:J,protocolName:N,sessionStart:er.current}),ei=()=>{eu(),A(!1),T(!1),P(e=>e+1),eo(),p&&X(),r((0,v.HU)(!1)),y(!1)};(0,u.useEffect)(()=>{let e=U.current;e&&(!C||D||j?e.pause():e.play().catch(console.error))},[C,D,j]),(0,u.useEffect)(()=>{if(!C||!_)return;let e=setInterval(()=>{(0,w.o)(Date.now(),_)>=l.u0&&ei()},3e4);return()=>clearInterval(e)},[C,_]);let es=(0,u.useMemo)(()=>C&&H&&H in I?I[H]:0,[C,H,I]);return(0,n.jsx)(g.Provider,{value:{isSessionActive:C,active:C,paused:D,recordingEnabled:W,waitingForSocket:R,selectedProtocolName:N,selectedProtocol:I,protocolPreview:L,countdown:O,phase:H,phaseAt:J,currentPhaseDuration:es,musicMuted:j,setMusicMuted:B,triggerSessionStart:ea,stopSession:ei,setPaused:T,setSelectedProtocolName:G,audioRef:U,prediction:$,predictionIdx:ee,predictionLabel:et,socketEnabled:p,socketStatus:Q,sessionStartRef:er,startSession:el},children:t})}function k(){let e=(0,u.useContext)(g);if(void 0===e)throw Error("useSession must be used within a SessionProvider");return e}},2784:(e,t,r)=>{r.d(t,{G:()=>a,j:()=>u});var n=r(5561);let u=()=>(0,n.wA)(),a=n.d4},4400:(e,t,r)=>{r.d(t,{Q0:()=>o,V9:()=>s,Vs:()=>c,a_:()=>a,gJ:()=>l,p9:()=>i});var n=r(370),u=r(682);let a={inhale:1,exhale:2,hold:0,holdWithout:0},l=(e,t,r)=>{let[n,l]=(0,u.useState)([]),[o,i]=(0,u.useState)(null);return(0,u.useEffect)(()=>{null!==t&&null!==r&&l([...n,t].slice(-10))},[t,r]),(0,u.useEffect)(()=>{if(null===e||0===n.length)return;let t=a[e],r=n[n.length-1];if(t===r)return void i(r);if(n.length<3)return;let u=n.slice(-3);u.every(e=>e===u[0])&&i(u[0])},[n,e]),o},o=e=>{switch(e){case"inhale":return n.Ru._({id:"2k5wZC"});case"exhale":return n.Ru._({id:"lqLmPT"});case"hold":case"holdWithout":return n.Ru._({id:"YJMNeo"});default:return n.Ru._({id:"tXkhj/"})}},i=e=>{switch(e){case 1:return n.Ru._({id:"2k5wZC"});case 2:return n.Ru._({id:"lqLmPT"});case 0:return n.Ru._({id:"YJMNeo"});default:throw Error("Unknown prediction: ".concat(e))}},s=366,c=180},6426:(e,t,r)=>{var n,u,a,l,o,i;function s(){let e=window.navigator.userAgent.toLowerCase();return/iphone|ipad|ipod|macintosh/.test(e)||!!navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&/macintosh/.test(e)}function c(){let e=window.navigator.userAgent.toLowerCase();return/^((?!chrome|android).)*safari/i.test(e)}r.d(t,{MG:()=>h,Q9:()=>p,bW:()=>d,lg:()=>s,nr:()=>c});let d=null==(u=navigator)||null==(n=u.mediaDevices)?void 0:n.getSupportedConstraints().echoCancellation,h=null==(l=navigator)||null==(a=l.mediaDevices)?void 0:a.getSupportedConstraints().noiseSuppression,p=null==(i=navigator)||null==(o=i.mediaDevices)?void 0:o.getSupportedConstraints().autoGainControl},7456:(e,t,r)=>{r.d(t,{WH:()=>u,hf:()=>i,kZ:()=>o});var n=r(682);let u={Focus:{inhale:4e3,hold:4e3,exhale:4e3,holdWithout:4e3},Relaxation:{inhale:4e3,exhale:6e3},Energy:{inhale:2e3,hold:1e3,exhale:2e3,holdWithout:1e3}},a=["inhale","hold","exhale","holdWithout"],l=["inhale","exhale"],o=.25;function i(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"Focus",o=u[r],i="hold"in o?a:l,s=i.reduce((e,t)=>e+(o[t]||0),0),[c,d]=(0,n.useState)("inhale"),h=(0,n.useRef)(0),p=(0,n.useRef)(null),f=()=>{h.current=(h.current+1)%i.length;let e=i[h.current];e&&d(e)};return(0,n.useEffect)(()=>{if(!e){clearTimeout(p.current),h.current=0,d("inhale");return}return t?void clearTimeout(p.current):(p.current=setTimeout(f,o[c]||0),()=>clearTimeout(p.current))},[e,t,c,o]),{phase:c,phaseAt:e=>{let t=(e%s+s)%s;for(let e of i){let r=o[e]||0;if(t<r)return e;t-=r}return"inhale"}}}}}]);